rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // Helper Functions
    // ============================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function hasRole(role) {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == role;
    }
    
    function isLandlord() {
      return hasRole('landlord');
    }
    
    function isApprovedLandlord() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'landlord' &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.approved == true;
    }
    
    function isTenant() {
      return hasRole('tenant');
    }
    
    function isAdmin() {
      return hasRole('admin');
    }
    
    function isParticipant(landlordId, tenantId) {
      return isAuthenticated() && 
             (request.auth.uid == landlordId || request.auth.uid == tenantId);
    }
    
    function isPropertyOwner(propertyId) {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/properties/$(propertyId)).data.landlordId == request.auth.uid;
    }
    
    // ============================================
    // Users Collection
    // ============================================
    // Access: Public read for basic user profiles (needed for property listings)
    // Users can only create/update their own profile
    // Admins can update approval status for landlords
    // Validates: Requirements 13.2 (access control)
    
    match /users/{userId} {
      allow read: if true; // Public read for displaying landlord info on property listings
      
      allow create: if isAuthenticated() && 
                      isOwner(userId) && 
                      request.resource.data.uid == userId &&
                      request.resource.data.keys().hasAll(['uid', 'email', 'name', 'role']);
      
      allow update: if isOwner(userId) || isAdmin();
      
      allow delete: if isOwner(userId) || isAdmin();
    }
    
    // ============================================
    // Properties Collection
    // ============================================
    // Access: Public read for property discovery and SEO
    // Only approved landlords can create properties
    // Only property owner can update/delete their properties
    // Validates: Requirements 13.2 (access control)
    
    match /properties/{propertyId} {
      allow read: if true; // Public read for property listings and SEO (Req 12.5)
      
      allow create: if isApprovedLandlord() && 
                      request.resource.data.landlordId == request.auth.uid &&
                      request.resource.data.keys().hasAll(['landlordId', 'address', 'city', 
                                                           'propertyType', 'bedrooms', 'bathrooms', 
                                                           'rentAmount', 'status']);
      
      allow update: if isApprovedLandlord() && 
                      resource.data.landlordId == request.auth.uid &&
                      request.resource.data.landlordId == resource.data.landlordId; // Prevent ownership transfer
      
      allow delete: if isApprovedLandlord() && 
                      resource.data.landlordId == request.auth.uid;
    }
    
    // ============================================
    // Leads Collection
    // ============================================
    // Access: Only participants (tenant and landlord) can access
    // Tenants can create leads
    // Both parties can update lead status
    // Validates: Requirements 13.2 (access control)
    
    match /leads/{leadId} {
      allow read: if isAuthenticated() && 
                    (resource.data.tenantId == request.auth.uid || 
                     resource.data.landlordId == request.auth.uid);
      
      allow create: if isTenant() && 
                      request.resource.data.tenantId == request.auth.uid &&
                      request.resource.data.keys().hasAll(['tenantId', 'propertyId', 
                                                           'landlordId', 'initialMessage', 'status']);
      
      allow update: if isAuthenticated() && 
                      (resource.data.tenantId == request.auth.uid || 
                       resource.data.landlordId == request.auth.uid) &&
                      request.resource.data.tenantId == resource.data.tenantId &&
                      request.resource.data.landlordId == resource.data.landlordId &&
                      request.resource.data.propertyId == resource.data.propertyId; // Prevent changing core fields
      
      allow delete: if resource.data.landlordId == request.auth.uid || isAdmin();
      
      // Messages Subcollection
      // Access: Only lead participants can read/write messages
      // Validates: Requirements 13.2 (access control)
      match /messages/{messageId} {
        allow read: if isAuthenticated() && 
                      (get(/databases/$(database)/documents/leads/$(leadId)).data.tenantId == request.auth.uid ||
                       get(/databases/$(database)/documents/leads/$(leadId)).data.landlordId == request.auth.uid);
        
        allow create: if isAuthenticated() && 
                        (get(/databases/$(database)/documents/leads/$(leadId)).data.tenantId == request.auth.uid ||
                         get(/databases/$(database)/documents/leads/$(leadId)).data.landlordId == request.auth.uid) &&
                        request.resource.data.senderId == request.auth.uid &&
                        request.resource.data.keys().hasAll(['senderId', 'content', 'read']);
        
        allow update: if isAuthenticated() && 
                        (get(/databases/$(database)/documents/leads/$(leadId)).data.tenantId == request.auth.uid ||
                         get(/databases/$(database)/documents/leads/$(leadId)).data.landlordId == request.auth.uid) &&
                        request.resource.data.senderId == resource.data.senderId; // Prevent sender change
        
        allow delete: if get(/databases/$(database)/documents/leads/$(leadId)).data.landlordId == request.auth.uid || 
                        isAdmin();
      }
    }
    
    // ============================================
    // Leases Collection
    // ============================================
    // Access: Only lease participants (landlord and tenant) can access
    // Approved landlords can create leases
    // Both parties can update (for signatures)
    // Validates: Requirements 13.2 (access control)
    
    match /leases/{leaseId} {
      allow read: if isAuthenticated() && 
                    (resource.data.landlordId == request.auth.uid || 
                     resource.data.tenantId == request.auth.uid ||
                     isAdmin());
      
      allow create: if isApprovedLandlord() && 
                      request.resource.data.landlordId == request.auth.uid &&
                      request.resource.data.keys().hasAll(['propertyId', 'landlordId', 'tenantId',
                                                           'rentAmount', 'startDate', 'endDate', 'status']);
      
      allow update: if isAuthenticated() && 
                      (resource.data.landlordId == request.auth.uid || 
                       resource.data.tenantId == request.auth.uid) &&
                      request.resource.data.landlordId == resource.data.landlordId &&
                      request.resource.data.tenantId == resource.data.tenantId &&
                      request.resource.data.propertyId == resource.data.propertyId; // Prevent changing core fields
      
      allow delete: if resource.data.landlordId == request.auth.uid || isAdmin();
    }
    
    // ============================================
    // Maintenance Requests Collection
    // ============================================
    // Access: Only participants (tenant and landlord) can access
    // Tenants can create maintenance requests
    // Both parties can update status and add notes
    // Validates: Requirements 13.2 (access control)
    
    match /maintenance/{requestId} {
      allow read: if isAuthenticated() && 
                    (resource.data.tenantId == request.auth.uid || 
                     resource.data.landlordId == request.auth.uid ||
                     isAdmin());
      
      allow create: if isTenant() && 
                      request.resource.data.tenantId == request.auth.uid &&
                      request.resource.data.keys().hasAll(['propertyId', 'tenantId', 
                                                           'landlordId', 'category', 'description', 'status']) &&
                      (!request.resource.data.keys().hasAny(['images']) || 
                       request.resource.data.images.size() <= 3); // Max 3 images (Req 6.2)
      
      allow update: if isAuthenticated() && 
                      (resource.data.tenantId == request.auth.uid || 
                       resource.data.landlordId == request.auth.uid) &&
                      request.resource.data.tenantId == resource.data.tenantId &&
                      request.resource.data.landlordId == resource.data.landlordId &&
                      request.resource.data.propertyId == resource.data.propertyId &&
                      (!request.resource.data.keys().hasAny(['images']) || 
                       request.resource.data.images.size() <= 3); // Enforce max 3 images on update
      
      allow delete: if resource.data.landlordId == request.auth.uid || isAdmin();
    }
    
    // ============================================
    // Invoices Collection
    // ============================================
    // Access: Only invoice owner (landlord) can read
    // Only admins can create/update invoices
    // Validates: Requirements 13.2 (access control)
    
    match /invoices/{invoiceId} {
      allow read: if isAuthenticated() && 
                    (resource.data.landlordId == request.auth.uid || isAdmin());
      
      allow create: if isAdmin() && 
                      request.resource.data.keys().hasAll(['landlordId', 'amount', 'dueDate', 'status']);
      
      allow update: if isAdmin();
      
      allow delete: if isAdmin();
    }
    
    // ============================================
    // Payments Collection
    // ============================================
    // Access: Only payment owner (landlord) can read
    // Landlords can create payments for their invoices
    // Admins can update/delete payments
    // Validates: Requirements 13.2 (access control)
    
    match /payments/{paymentId} {
      allow read: if isAuthenticated() && 
                    (resource.data.landlordId == request.auth.uid || isAdmin());
      
      allow create: if isAuthenticated() && 
                      (request.resource.data.landlordId == request.auth.uid || isAdmin()) &&
                      request.resource.data.keys().hasAll(['invoiceId', 'landlordId', 
                                                           'amount', 'paymentMethod', 'paymentDate']);
      
      allow update: if isAdmin();
      
      allow delete: if isAdmin();
    }
    
    // ============================================
    // Campaigns Collection
    // ============================================
    // Access: Landlords can read their own campaigns
    // Admins can read all campaigns
    // Only admins can create/update/delete campaigns
    // Validates: Requirements 13.2 (access control)
    
    match /campaigns/{campaignId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAdmin();
    }
    
    // ============================================
    // Notifications Collection
    // ============================================
    // Access: Only notification owner can read/update
    // System (authenticated users) can create notifications
    // Validates: Requirements 13.2 (access control)
    
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && 
                    resource.data.userId == request.auth.uid;
      
      allow create: if isAuthenticated() && 
                      request.resource.data.keys().hasAll(['userId', 'type', 'title', 'message', 'read']);
      
      allow update: if isOwner(resource.data.userId) &&
                      request.resource.data.userId == resource.data.userId; // Prevent ownership transfer
      
      allow delete: if isOwner(resource.data.userId) || isAdmin();
    }
    
    // ============================================
    // User Preferences Collection
    // ============================================
    // Access: Only user can read/write their own preferences
    // Validates: Requirements 13.2 (access control)
    
    match /userPreferences/{userId} {
      allow read: if isOwner(userId);
      
      allow create: if isOwner(userId) && 
                      request.resource.data.userId == userId;
      
      allow update: if isOwner(userId) &&
                      request.resource.data.userId == userId;
      
      allow delete: if isOwner(userId);
    }
    
    // ============================================
    // Saved Properties Subcollection
    // ============================================
    // Access: Only user can read/write their own saved properties
    // Validates: Requirements 13.2 (access control)
    
    match /users/{userId}/savedProperties/{propertyId} {
      allow read: if isOwner(userId);
      
      allow create: if isOwner(userId) && 
                      request.resource.data.keys().hasAll(['propertyId']);
      
      allow update: if isOwner(userId);
      
      allow delete: if isOwner(userId);
    }
    
    // ============================================
    // Property Views Collection
    // ============================================
    // Access: Public can create views (for analytics)
    // Only admins can read/update/delete views
    // Validates: Requirements 13.2 (access control)
    
    match /propertyViews/{viewId} {
      allow read: if isAdmin();
      allow create: if true; // Allow anonymous view tracking for analytics
      allow update, delete: if isAdmin();
    }
  }
}
